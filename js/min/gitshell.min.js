var repo_commits_diff_nav_template='    <ul class="nav nav-tabs" style="margin-bottom: 10px">        <li class="c_pull_request_action active" data-action="commit"><a href="javascript:void(0)">Commits</a></li>        <li class="c_pull_request_action" data-action="diff">            <a href="javascript:void(0)">Diff</a>        </li>        <li id="i_select_line_context" class="dropdown hide">            <a class="dropdown-toggle" data-toggle="dropdown" href="javascript:void(0)">\u4e0a\u4e0b\u884c\u6570(<span id="i_line_context">3</span>) <b class="caret"></b></a>            <ul class="dropdown-menu">                <li><a class="c_line_context" href="javascript:void(0)">3</a></li>                <li><a class="c_line_context" href="javascript:void(0)">5</a></li>                <li><a class="c_line_context" href="javascript:void(0)">10</a></li>                <li><a class="c_line_context" href="javascript:void(0)">20</a></li>            </ul>        </li>    </ul>    <div id="i_pull_meta_data">        <div id="i_ajax_loading" class="c_pull_request_content"><img style="margin-left: 50px" src=\'/static/img/loading.gif\'></div>        <div id="i_pull_request_commits" class="c_pull_request_content hide"></div>        <div id="i_pull_request_diff" class="c_pull_request_content hide"></div>    </div>',
repo_commits_template='   <table class="table table-striped"><thead class="fixed"><tr><th width="20%">\u63d0\u4ea4HASH (\u4f5c\u8005)</th><th width="10%">\u65f6\u95f4</th><th>\u65e5\u5fd7</th></tr></thead><tbody>       <% _.each(commits, function(commit){ %>           <tr><td><code><%-commit.commit_hash%></code><span>(<%-commit.committer_name%>)</span></td><td><span style="display: inline;"><%-commit.committer_moment%></span></td><td><%-commit.commit_message%></td></tr>       <% }); %>   </tbody></table>',
repo_commits_tmpl=_.template(repo_commits_template);repo_diff_template='<div id="diff">   <% if(diff.numstat.length == 0){ %>   <p>\u6ca1\u6709\u4e0d\u540c\u7684\u5730\u65b9</p>   <% } %>   <div class="diff-header">       <p>\u4fee\u6539\u6587\u4ef6(<%-diff.changedfiles_count%>), \u6dfb\u52a0\u884c\u6570(<%-diff.total_add_line%>), \u5220\u9664\u884c\u6570(<%-diff.total_delete_line%>), \u603b\u8ba1\u884c\u6570(<%-diff.abs_change_line%>)</p>       <ul class="diff-list">       <% _.each(diff.numstat, function(numstat){ %>           <li class="clearfix"><span class="diff-linenumber clearfix"><span class="added">+ <%-numstat[0]%></span><span class="removed">- <%-numstat[1]%></span></span><a href="#chg-<%-numstat[2]%>"><%-numstat[2]%></a></li>       <% }); %>       </ul>   </div>   <div class="diff-body">       <% _.each(diff.detail, function(detail){ %>       <div class="diff-item-container">               <div class="item-header clearfix"><h3 id="chg-<%-detail.filename%>" class="heading"><%-detail.filename%></h3><a href="<%-detail.filepath%>" class="view-file">View File</a></div>               <div class="item-body">                 <div class="data-container">                   <% _.each(detail.linediff, function(linediff){ %>                       <% _.each(linediff, function(linediff_item){ %>                       <div class="<%-linediff_item[3]%>">                           <a href="javascript:void(0)" class="line-numbers"><span class="l1"><%-linediff_item[0]%></span><span class="l2"><%-linediff_item[1]%></span></a>                           <pre class="data"><%=linediff_item[2]%></pre>                       </div>                       <% }) %>                   <% }) %>                </div>               </div>           </div>       <% }); %>   </div></div>';
var repo_diff_tmpl=_.template(repo_diff_template);(function(t){function r(a,c,d,f){this.user_name=a;this.repo_name=c;this.from_refs=d;this.to_refs=f;this.path="";this.line_context=3;this.is_pull=!1}var q=$("meta[name=csrf-token]").attr("content");_.mixin(_.str.exports());moment.lang("zh-cn");$("body").contents().filter(function(){return 8==this.nodeType}).remove();$(".unixtime").each(function(a){$(this).html(moment(new Date(1E3*$(this).html())).fromNow());$(this).show()});$(".dropdown-toggle").dropdown();r.prototype={setPullUsername:function(a,c){this.source_repo_username=
a;this.desc_repo_username=c;this.is_pull=!0},setLineContext:function(a){this.line_context=a},loadDiff:function(a,c,d){var f=this.is_pull?_.sprintf("/%s/%s/pull/diff/%s:%s..%s:%s/%s/",this.user_name,this.repo_name,this.source_repo_username,this.from_refs,this.desc_repo_username,this.to_refs,this.line_context):_.sprintf("/%s/%s/diff/%s..%s/%s/",this.user_name,this.repo_name,this.from_refs,this.to_refs,this.line_context);this.is_pull||""==this.path||(f+=this.path);$.post(f,{csrfmiddlewaretoken:q},function(f){c&&
c(f);var p=f.diff.detail;for(x in p){var g=p[x].linediff;for(y in g){var l=0;for(z in g[y]){var b=g[y][z][0],h=g[y][z][1],e=g[y][z][2],m=0!=b&&0==h,n=0==b&&0!=h,k="common";m&&(k="deletion",e="-"+e);n&&(k="addition",e="+"+e);m||n||(e=" "+e);e=e.replace(/ /g,"&nbsp;");0==b&&(b="");0==h&&(h="");0==l&&(k+=" first");l==g[y].length-1&&(k+=" last");g[y][z][0]=b;g[y][z][1]=h;g[y][z][2]=e;g[y][z].push(k);l+=1}}}p=repo_diff_tmpl(f);a.html(p);d&&d(f)})},loadCommits:function(a,c,d,f){var s=this.is_pull?_.sprintf("/%s/%s/pull/commits/%s:%s...%s:%s/",
this.user_name,this.repo_name,this.desc_repo_username,this.to_refs,this.source_repo_username,this.from_refs):_.sprintf("/%s/%s/commits/%s...%s/",this.user_name,this.repo_name,this.to_refs,this.from_refs),p=this.from_refs,g=this.to_refs,l=this.is_pull;$.post(s,{csrfmiddlewaretoken:q},function(b){c&&c(b);var h=!1,e=l?b.source_repo_refs_commit_hash.substr(0,7):b.from_commit_hash.substr(0,7),m=l?b.desc_repo_refs_commit_hash.substr(0,7):b.to_commit_hash.substr(0,7),n={};n[m]=1;for(var k in b.commits){m=
b.commits[k];if(m.commit_hash in n)for(y in b.commits[k].parent_commit_hash)n[b.commits[k].parent_commit_hash[y]]=1;var q=moment(new Date(1E3*m.committer_date)).fromNow();m.committer_moment=q}e in n&&(h=!0);e="<p>Already up-to-date. \u4f60\u5e76\u4e0d\u9700\u8981\u8fdb\u884c\u5408\u5e76\u64cd\u4f5c</p>";h||(e=repo_commits_tmpl(b));a.html(e);h||(b.allow_merge=!0);!l&&(h=b.refs_meta,0>h.branches.indexOf(p)||0>h.branches.indexOf(g))&&(b.allow_merge=!1);d&&d(b);f&&f(b)})},selectDiff:function(a,c){},selectCommits:function(a,
c){},navDiff:function(){$(".c_pull_request_content").each(function(a){$(this).hide()});$("#i_pull_request_diff").show()},navCommits:function(){$(".c_pull_request_content").each(function(a){$(this).hide()});$("#i_pull_request_commits").show()},renderCompare:function(a,c){a.html(repo_commits_diff_nav_template);var d=this;$(".c_pull_request_action").click(function(){var a=$(this).data("action");$(".c_pull_request_action").each(function(a){$(this).removeClass("active")});$(this).addClass("active");$(".c_pull_request_content").each(function(a){$(this).hide()});
$("#i_ajax_loading").show();"commit"==a?($("#i_select_line_context").hide(),d.loadCommits($("#i_pull_request_commits"),null,d.navCommits,c)):"diff"==a&&($("#i_select_line_context").show(),d.loadDiff($("#i_pull_request_diff"),null,d.navDiff))});$(".c_line_context").click(function(){$("#i_line_context").text($(this).text());d.setLineContext($(this).text());d.loadDiff($("#i_pull_request_diff"),null,this.navDiff)});this.loadCommits($("#i_pull_request_commits"),null,this.navCommits,c)}};this.csrfmiddlewaretoken=
q;this.RepoComparer=r}).call(this);
