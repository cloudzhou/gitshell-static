var repo_commits_diff_nav_template='    <ul class="nav nav-tabs">        <li class="cPullRequestAction active" data-action="commit"><a href="javascript:void(0)">Commits</a></li>        <li class="cPullRequestAction" data-action="diff">            <a href="javascript:void(0)">Diff</a>        </li>        <li id="selectLineContext" class="dropdown hide">            <a class="dropdown-toggle" data-toggle="dropdown" href="javascript:void(0)">Diff Context \u4e0a\u4e0b\u884c\u6570(<span id="lineContext">3</span>) <b class="caret"></b></a>            <ul class="dropdown-menu">                <li><a class="cLineContext" href="javascript:void(0)">3</a></li>                <li><a class="cLineContext" href="javascript:void(0)">5</a></li>                <li><a class="cLineContext" href="javascript:void(0)">10</a></li>                <li><a class="cLineContext" href="javascript:void(0)">20</a></li>            </ul>        </li>    </ul>    <div id="pullMetaData" class="bubble">        <div class="ajaxLoader" class="cPullRequestContent"><img src=\'/static/img/loading.gif\' alt="loader"><p>\u6b63\u5728\u52a0\u8f7d...</p></div>        <div id="pullRequestCommits" class="cPullRequestContent hide"></div>        <div id="pullRequestDiff" class="cPullRequestContent hide"></div>    </div>',
repo_commits_template='   <table class="table"><thead><tr><th>\u63d0\u4ea4HASH (\u4f5c\u8005)</th><th>\u65f6\u95f4</th><th>\u65e5\u5fd7</th></tr></thead><tbody>       <% _.each(commits, function(commit){ %>           <tr><td><code><%-commit.commit_hash%></code><span>(<%-commit.committer%>)</span></td><td><span><%-commit.committer_moment%></span></td><td><%-commit.commit_message%></td></tr>       <% }); %>   </tbody></table>',repo_commits_tmpl=_.template(repo_commits_template);repo_diff_template='   <% if(diff.numstat.length == 0){ %>   <p>\u6ca1\u6709\u4e0d\u540c\u7684\u5730\u65b9</p>   <% } %>   <div class="diff-header">       <ul class="diff-list">       <% _.each(diff.numstat, function(numstat){ %>           <li class="clearfix"><span class="diff-linenumber clearfix"><span class="added">+ <%-numstat[0]%></span><span class="removed">- <%-numstat[1]%></span></span><a href="#chg-<%-numstat[2]%>"><%-numstat[2]%></a></li>       <% }); %>       </ul>   </div>   <div class="diff-body">       <% _.each(diff.detail, function(detail){ %>       <section class="diff-item-container">               <header class="item-header clearfix"><h1 id="chg-<%-detail.filename%>" class="heading"><%-detail.filename%></h1><a href="<%-detail.filepath%>" class="view-file">View File</a></header>               <div class="item-body">                 <div class="data-container">                   <% _.each(detail.linediff, function(linediff){ %>                       <% _.each(linediff, function(linediff_item){ %>                       <div class="<%-linediff_item[3]%>">                           <a href="javascript:void(0)" class="line-numbers"><span class="l1"><%-linediff_item[0]%></span><span class="l2"><%-linediff_item[1]%></span></a>                           <pre class="data"><%=linediff_item[2]%></pre>                       </div>                       <% }) %>                   <% }) %>                </div>               </div>           </section>       <% }); %>   </div>';
var repo_diff_tmpl=_.template(repo_diff_template);(function(t){function r(c,d,e,b){this.user_name=c;this.repo_name=d;this.from_refs=e;this.to_refs=b;this.path="";this.line_context=3;this.is_pull=!1}var q=$("meta[name=csrf-token]").attr("content");r.prototype={setPullUsername:function(c,d){this.source_repo_username=c;this.desc_repo_username=d;this.is_pull=!0},setLineContext:function(c){this.line_context=c},loadDiff:function(c,d,e){var b=this.is_pull?_.sprintf("/%s/%s/pull/diff/%s:%s..%s:%s/%s/",this.user_name,this.repo_name,this.source_repo_username,
this.from_refs,this.desc_repo_username,this.to_refs,this.line_context):_.sprintf("/%s/%s/diff/%s..%s/%s/",this.user_name,this.repo_name,this.from_refs,this.to_refs,this.line_context);this.is_pull||""==this.path||(b+=this.path);$.post(b,{csrfmiddlewaretoken:q},function(b){d&&d(b);var p=b.diff.detail;for(x in p){var g=p[x].linediff;for(y in g){var l=0;for(z in g[y]){var a=g[y][z][0],h=g[y][z][1],f=g[y][z][2],m=0!=a&&0==h,n=0==a&&0!=h,k="common";m&&(k="deletion",f="-"+f);n&&(k="addition",f="+"+f);m||
n||(f=" "+f);f=f.replace(/ /g,"&nbsp;");0==a&&(a="");0==h&&(h="");0==l&&(k+=" first");l==g[y].length-1&&(k+=" last");g[y][z][0]=a;g[y][z][1]=h;g[y][z][2]=f;g[y][z].push(k);l+=1}}}p=repo_diff_tmpl(b);c.html(p);e&&e(b)})},loadCommits:function(c,d,e,b){var s=this.is_pull?_.sprintf("/%s/%s/pull/commits/%s:%s...%s:%s/",this.user_name,this.repo_name,this.desc_repo_username,this.to_refs,this.source_repo_username,this.from_refs):_.sprintf("/%s/%s/commits/%s...%s/",this.user_name,this.repo_name,this.to_refs,
this.from_refs),p=this.from_refs,g=this.to_refs,l=this.is_pull;$.post(s,{csrfmiddlewaretoken:q},function(a){d&&d(a);var h=!1,f=l?a.source_repo_refs_commit_hash.substr(0,7):a.from_commit_hash.substr(0,7),m=l?a.desc_repo_refs_commit_hash.substr(0,7):a.to_commit_hash.substr(0,7),n={};n[m]=1;for(var k in a.commits){m=a.commits[k];if(m.commit_hash in n)for(y in a.commits[k].parent_commit_hash)n[a.commits[k].parent_commit_hash[y]]=1;var q=moment(new Date(1E3*m.committer_date)).fromNow();m.committer_moment=
q}f in n&&(h=!0);f="<p>Already up-to-date.</p>";h||(f=repo_commits_tmpl(a));c.html(f);h||(a.allow_merge=!0);!l&&(h=a.refs_meta,0>h.branches.indexOf(p)||0>h.branches.indexOf(g))&&(a.allow_merge=!1);e&&e(a);b&&b(a)})},selectDiff:function(c,d){},selectCommits:function(c,d){},navDiff:function(){$(".cPullRequestContent").each(function(c){$(this).hide()});$("#pullRequestDiff").show()},navCommits:function(){$(".cPullRequestContent").each(function(c){$(this).hide()});$("#pullRequestCommits").show()},renderCompare:function(c,
d){c.html(repo_commits_diff_nav_template);var e=this;$(".cPullRequestAction").click(function(){var b=$(this).data("action");$(".cPullRequestAction").each(function(b){$(this).removeClass("active")});$(this).addClass("active");$(".cPullRequestContent").each(function(b){$(this).hide()});$(".ajaxLoader").show();"commit"==b?($("#selectLineContext").hide(),e.loadCommits($("#pullRequestCommits"),null,e.navCommits,d)):"diff"==b&&($("#selectLineContext").show(),e.loadDiff($("#pullRequestDiff"),null,e.navDiff))});
$(".cLineContext").click(function(){$("#i_line_context").text($(this).text());e.setLineContext($(this).text());e.loadDiff($("#pullRequestDiff"),null,this.navDiff)});this.loadCommits($("#pullRequestCommits"),null,this.navCommits,d)}};this.csrfmiddlewaretoken=q;this.RepoComparer=r}).call(this);
